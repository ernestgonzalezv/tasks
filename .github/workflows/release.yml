name: ğŸš€ Release Pipeline

on:
  push:
    branches:
      - main

jobs:
  release:
    name: Test + Build + Release
    runs-on: ubuntu-latest

    steps:
      # ğŸ”„ Checkout del repositorio
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v4

      # â”€â”€â”€â”€â”€â”€â”€â”€ ğŸ”§ BACKEND: Laravel API (./api) â”€â”€â”€â”€â”€â”€â”€â”€

      # ğŸ› ï¸ Setup PHP para Laravel
      - name: ğŸ› ï¸ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, pdo, mysql, xdebug
          tools: composer

      # ğŸ“¦ Instalar dependencias de Laravel
      - name: ğŸ“¦ Install Composer dependencies
        working-directory: ./api
        run: composer install --no-progress --no-interaction

      # âš™ï¸ Configurar Laravel (.env + app key)
      - name: âš™ï¸ Set Laravel .env
        working-directory: ./api
        run: |
          cp .env.example .env
          php artisan key:generate

      # ğŸ§ª Tests + Coverage Laravel
      - name: ğŸ§ª Run Laravel tests with Coverage
        working-directory: ./api
        run: |
          mkdir -p coverage
          php artisan test --coverage-clover=coverage/clover.xml

    

      # ğŸ“¤ Subir artefacto del backend
      - name: ğŸ“¤ Upload API artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-artifact
          path: ./api/

      # â”€â”€â”€â”€â”€â”€â”€â”€ ğŸ–¥ï¸ FRONTEND: Cliente (./frontend) â”€â”€â”€â”€â”€â”€â”€â”€

      # ğŸ› ï¸ Setup Node.js
      - name: ğŸ› ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ğŸ“¦ Instalar dependencias del frontend
      - name: ğŸ“¦ Install frontend deps
        working-directory: ./frontend
        run: npm install

      # ğŸ§± Build frontend
      - name: ğŸ§± Build frontend
        working-directory: ./frontend
        run: npm run build

      # ğŸ“¤ Subir build del frontend como artefacto
      - name: ğŸ“¤ Upload frontend build
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: ./frontend/dist/

      # â”€â”€â”€â”€â”€â”€â”€â”€ ğŸš€ RELEASE â”€â”€â”€â”€â”€â”€â”€â”€

      # ğŸ·ï¸ Crear una release en GitHub con changelog automÃ¡tico
      - name: ğŸš€ Publish release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
